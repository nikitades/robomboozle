# Установка ПО

## Разворот и сборка

1. Склонируйте этот репозиторий куда-нибудь у себя на компьютере:

    `git clone git@github.com:nikitades/robomboozle.git ~/robomboozle`

2. Перейдите в папку с клиентом:

    `cd ~/robomboozle/client`

3. Запускаем деплой кода на RPI:

    `npm run deploy`

    Если всё успешно, в конце должно быть что-то вроде
    ```
    added 59 packages from 103 contributors in 56.957s
    Connection to 192.168.1.170 closed.
    ```

4. Устанавливаем корректные параметры подключения:

    1. Логинимся по ssh к pi:

        `ssh pi`

    2. Переходим в папку с исходным кодом клиента:

        `cd ~/robomboozle_client`

    3. Открываем для редактирования файл `runClient.sh`

        `nano runClient.sh`

    4. В файле меняем значения на свои:

    ```
    [ -z "$tcpHost" ] && tcpHost="АДРЕС СЕРВЕРА (для тестов ваш комп, для прода какой-нибудь постоянно работающий ПК вроде digital ocean или aws)"
    [ -z "$tcpPort" ] && tcpPort="9000 (порт подключения для стриминга видео по TCP)"
    [ -z "$wsHost" ] && wsHost="АДРЕС СЕРВЕРА (для тестов ваш комп, для прода какой-нибудь постоянно работающий ПК вроде digital ocean или aws)"
    [ -z "$wsPort" ] && wsPort="8000 (порт подключения для управления командами)"
    [ -z "$secret" ] && secret="abcdef (пароль сервера для робота, по умолчанию abcdef)"
    [ -z "$rotation" ] && rotation="180 (градус программного поворота изображения - а то мало ли как вы установили камеру, можно развернуть)"
    ```

    Пример хорошо заполненного файла для локального теста:

    ```
    [ -z "$tcpHost" ] && tcpHost="192.168.1.111"
    [ -z "$tcpPort" ] && tcpPort="9000"
    [ -z "$wsHost" ] && wsHost="192.168.1.111"
    [ -z "$wsPort" ] && wsPort="8000"
    [ -z "$secret" ] && secret="abcdef"
    [ -z "$rotation" ] && rotation="180"
    ```

    Строчку `#!/bin/sh` или `#!/bin/bash` (shebang) просто оставьте на месте.

    5. Перезапускаем системную службу

    Т.к. после деплоя сразу запускается системная служба, отслеживающая онлайн сервера-хоста, в оперативной памяти на данный момент неверные настройки. Чтобы стали верные, службу нужно перезапустить.

    ```
    sudo systemctl restart robomboozle.service
    ```

    После этого осталось заняться хостом. Как только хост включится, при условии, что вы вписали корректные параметры, видео-трансляция начнется автоматически, и всё остальное тоже заработает.
 
## Запуск сервера

1. Запуск сервера из Docker-образа (проще)

    Разумеется, у вас должен быть уже установлен и готов к использованию Docker.
    linux: google://how to install docker linux
    osx: google://how to install docker osx

    1. `docker run -it -p 8000:8000 -p 9000:9000 -e piSecret=abcdef -e steerSecret=fedcba -e watchSecret=aaaaaa nikitades/robomboozle-server:latest`
    - -p 8000:8000 - внутренний порт веб-служб 8000, наружу экспозируйте как нравится. Помните, что этот порт фигурирует как wsPort в runClient.sh
    - -p 9000:9000 - внутренний порт tcp-службы 9000, наружу экспозируйте как нравится. Помните, что этот порт фигурирует как tcpPort в runClient.sh
    - -e piSecret - пароль на подключение робота к шине команд. Этот параметр фигурирует как secret в runClient.sh
    - -e steerSecret - пароль для пользователя-управляющего. По умолчанию fedcba
    - -e watchSecret - пароль для пользователя-зрителя. По умолчанию aaaaaa

    После запуска команды перейдите по `http://localhost:8000` и логиньтесь в веб-интерфейс.

2. Запуск сервера из исходных файлов (сложнее)

    Сначала компилируем, потом запускаем.

    1. Перейдите в папку со склонированным репозиторием, в подпапку сервера:

        `cd ~/robomboozle/server`

    2. Запустите сборку сервера

        `sh ./buildServer.sh`

    3. Запустите сервер

        `sh ./runServer.sh`

    Важно: файл настраиваемый, по тому же принципу что и `runClient.sh`

    Пример настройки (параметры под теми же именами (кроме piSecret, который просто secret в `runClient.sh`), порты захардкожены на 8000 и 9000):

    ```
    [ -z "$piSecret" ] && piSecret="abcdef"
    [ -z "$steerSecret" ] && steerSecret="fedcba"
    [ -z "$watchSecret" ] && watchSecret="aaaaaa"
    ```

    После запуска файла перейдите по `http://localhost:8000` и логиньтесь в веб-интерфейс.


## Запуск сервера удаленно (на хостинге)

Почти ничем не отличается от обычного запуска сервера. Единственное отличие в том, что вам придется убедиться, что служба запускается при включении компьютера и перезапускается в случае падения. Для этого можно использовать что-то из этого: Systemd, docker-compose, docker swarm.